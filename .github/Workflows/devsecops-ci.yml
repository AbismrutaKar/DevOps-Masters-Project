name: DevSecOps CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  tfsec-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install tfsec
        run: |
          curl -sSL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
      - name: Run tfsec
        run: tfsec ./terraform

  docker-trivy-scan:
    runs-on: ubuntu-latest
    needs: tfsec-scan
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker Image
        run: docker build -t myapp:latest ./build
      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: myapp:latest
          format: 'table'
          exit-code: '0'

  deploy-kubernetes:
    runs-on: ubuntu-latest
    needs: docker-trivy-scan
    steps:
      - uses: actions/checkout@v3

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: '1.27.0'

      - name: Install kubeseal CLI
        run: |
          wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.26.1/kubeseal-linux-amd64 -O kubeseal
          chmod +x kubeseal && sudo mv kubeseal /usr/local/bin/

      - name: Apply sealed secrets
        run: kubectl apply -f k8s/secrets/db-secret-sealed.yaml

      - name: Deploy application
        run: kubectl apply -f k8s/deployment.yaml

  terraform-apply:
    runs-on: ubuntu-latest
    needs: deploy-kubernetes
    steps:
      - uses: actions/checkout@v3
      - name: Terraform Init & Apply
        uses: hashicorp/terraform-github-actions@v2.0.2
        with:
          tf_actions_working_dir: ./terraform
          tf_actions_subcommand: 'apply'
          tf_actions_auto_approve: true
